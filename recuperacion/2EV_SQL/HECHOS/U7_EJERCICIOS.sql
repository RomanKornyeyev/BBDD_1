/* === EJERCICIO EJEMPLO UNIQUE === */
DROP TABLE PROVINCIAS CASCADE CONSTRAINTS;
CREATE TABLE PROVINCIAS (
	COD_PROV NUMBER(2) CONSTRAINT PK_PROVINCIAS PRIMARY KEY CHECK (COD_PROV BETWEEN 1 AND 50),
	NB_PROV VARCHAR(10) NOT NULL UNIQUE
);

DROP TABLE PERSONAS CASCADE CONSTRAINTS;
CREATE TABLE PERSONAS (
	DNI VARCHAR(10) CONSTRAINT PK_PERSONAS PRIMARY KEY,
	NB VARCHAR(15) NOT NULL CHECK(NB=UPPER(NB)),
	DIR VARCHAR(20) NOT NULL,
	COD_PROV NUMBER(2) NOT NULL CONSTRAINT FK_PERSONAS REFERENCES PROVINCIAS(COD_PROV) ON DELETE CASCADE
);











/* === EJERCICIO 2 (NO SÉ SI ESTÁ BIEN AL 100%) === */
/*1. Añadir a la tabla PROFESORES una columna llamada COD_ASIG con dos posiciones numéricas.*/
ALTER TABLE PROFESORES ADD COD_ASIG NUMBER(2);

/*2. Crear la tabla TASIG con las siguientes columnas:COD_ASIG numérico, 2 posiciones y NOM_ASIG cadena de 20 caracteres.*/
DROP TABLE TASIG CASCADE CONSTRAINTS;
CREATE TABLE TASIG (
    COD_ASIG NUMBER(2),
    NOM_ASIG VARCHAR(20)
);

/*3. Añadir la restricción de clave primaria a la columna COD_ASIG  de la tabla anterior.*/
ALTER TABLE TASIG ADD CONSTRAINT PK_COD_ASIG PRIMARY KEY (COD_ASIG);

/*4. Añadir la restricción clave ajena a la columna COD_ASIG de la tabla PROFESORES.*/
ALTER TABLE PROFESORES ADD CONSTRAINT FK_COD_ASIG REFERENCES (COD_ASIG) ON DELETE CASCADE; /* ===???=== */

/*5. Cambiar el nombre de la tabla PROFESORES y llamarla PROFES.*/
ALTER TABLE PROFESORES RENAME PROFES; /* ===???=== */

/*6. Borrar la tabla TASIG.*/
DROP TABLE TASIG;

/*7. Devolver la tabla PROFESORES a su situación inicial.*/
ROLLBACK PROFES; /* ===???=== */











/* ====== TIPO EXAMEN ====== */
/* === EJER 3 === */
DROP TABLE DEPARTAMENTO CASCADE CONSTRAINTS;
CREATE TABLE DEPARTAMENTO(
	COD_DEP VARCHAR(10) CONSTRAINT PK_DEPART PRIMARY KEY,
	NOMBRE VARCHAR(25) NOT NULL ,
	LOCALIDAD VARCHAR(25) NOT NULL,
	CONSTRAINT UNICO UNIQUE (NOMBRE)
);
/* UNIQUE (justo después de NOT NULL (de NOMBRE)) */
/* vale de las 2 formas el unique, PERO SI MANDA BORRARLA, HACE FALTA EL CONTRAINT */

DROP TABLE EMPLEADO CASCADE CONSTRAINTS;
CREATE TABLE EMPLEADO (
	COD_EMP VARCHAR(10) CONSTRAINT PK_EMP PRIMARY KEY,
	DNI VARCHAR(15) NOT NULL,
	NOMBRE VARCHAR(25) NOT NULL,
	DIR VARCHAR(50) NOT NULL,
	CP NUMBER(5) NOT NULL,
	POBLACION VARCHAR(25) NOT NULL,
	COD_DEP VARCHAR(10) NOT NULL CONSTRAINT FK_EMP REFERENCES DEPARTAMENTO(COD_DEP) ON DELETE CASCADE
);

DROP TABLE PROYECTO CASCADE CONSTRAINTS;
CREATE TABLE PROYECTO (
	COD_PROY VARCHAR(10) CONSTRAINT PK_PROY PRIMARY KEY,
	NOMBRE VARCHAR(10) NOT NULL UNIQUE
);

DROP TABLE HACER_PROYECTO CASCADE CONSTRAINTS;
CREATE TABLE HACER_PROYECTO (
	COD_EMP VARCHAR(10),
	COD_PROY VARCHAR(10),
	FECHA_I DATE NOT NULL,
	FECHA_F DATE,
	CONSTRAINT FK_HP_EMP FOREIGN KEY (COD_EMP) REFERENCES EMPLEADO(COD_EMP) ON DELETE CASCADE,
	CONSTRAINT FK_HP_PROY FOREIGN KEY (COD_PROY) REFERENCES PROYECTO(COD_PROY) ON DELETE CASCADE,
	CONSTRAINT PK_HP PRIMARY KEY (COD_EMP,COD_PROY)
);


/* === ALTER TABLES === */
/* Añadir el campo SALARIO a la tabla  EMPLEADO */
ALTER TABLE EMPLEADO ADD SUELDO NUMBER(10) NOT NULL;

/* Modificar las columnas de las tablas DEPARTAMENTO y EMPLEADO para que el nombre pueda almacenar más caracteres */
ALTER TABLE DEPARTAMENTO MODIFY NOMBRE VARCHAR(50);
ALTER TABLE EMPLEADO MODIFY NOMBRE VARCHAR(50);

/* A partir de la tabla DEPARTAMENTO impide que se puedan dar de alta más departamentos en la localidad de GETAFE */
ALTER TABLE DEPARTAMENTO ADD CONSTRAINT DK CHECK (LOCALIDAD<>'GETAFE'); /*SOLUCIÓN PROFE*/

/* Eliminar la restricción de UNIQUE de la columna NOMBRE de la tabla PROYECTO */
ALTER TABLE PROYECTO DROP UNIQUE (NOMBRE); /*NO FUNCIONA, SI QUIERO ELIMINARLA, TIENE QUE TENER CONSTRAINT*/
ALTER TABLE PROYECTO DROP CONSTRAINT UNICO; /*SOLUCIÓN PROFE (NO FUNCIONA), PERO EN TEORÍA ES ASÍ*/

/* Insertar la siguiente tupla en HACER_PROYECTO (0001-E, 0001-P, 20 DE FEBRERO DE 2009, NULOS) */
INSERT INTO DEPARTAMENTO VALUES('0001-D', 'DEPART-1', 'MAD');
INSERT INTO EMPLEADO VALUES('0001-E', '12312Z', 'ROMAN', 'CALLE SOL', 28038, 'MADRID', '0001-D');
INSERT INTO PROYECTO VALUES('0001-P', 'PROY-1');
INSERT INTO HACER_PROYECTO VALUES('0001-E','0001-P','20/02/2009', NULL);
COMMIT;

/* Crear una vista llamada EMPLE_PROYECTO que contenga el NB_EMPLE, NB_PROY de aquellos proyectos realizados entre el 18/01/2009 y 18/02/2009 */
CREATE OR REPLACE VIEW EMPLE_PROYECTO AS 
(SELECT E.NOMBRE "NOMBRE", P.NOMBRE "PROYECTO"
FROM EMPLEADO E, PROYECTO P, HACER_PROYECTO H 
WHERE E.COD_EMP=H.COD_EMP AND P.COD_PROY=H.COD_PROY AND FECHA_I>'18/01/2009' AND FECHA_F<'18/02/2009');











/* === TIPO EXAMEN === */
/* === EJER 4 === */
/*SI NO ESTÁ ON DELETE CASCADE, ESTÁ EN MODO RESTRINGIDO, ES DECIR,
SI TENEMOS EL ALUMNO EN "ALUMNO" E "IMPARTE" E INTENTAMOS BORRARLO DE ALUMNO,
NO NOS VA A DEJAR*/
DROP TABLE ASIGNATURA cascade constraints; 
CREATE TABLE ASIGNATURA (
    COD_ASIG VARCHAR (10) CONSTRAINT PK_ASIG PRIMARY KEY,
    NB_ASIG VARCHAR (20)
);

DROP TABLE DEPARTAMENTO cascade constraints; 
CREATE TABLE DEPARTAMENTO(
    COD_DEP VARCHAR (20) CONSTRAINT PK_DEP PRIMARY KEY,
    NB_DEP VARCHAR (20)
);

DROP TABLE PROFESOR cascade constraints; 
CREATE TABLE PROFESOR (
     DNI_PROF VARCHAR (20) PRIMARY KEY,
     NB_PROF VARCHAR (20),
     DIR_PROF VARCHAR (20),
     TF_PROF NUMBER (20),
     SUELDO_PROF NUMBER (10),
     COD_DEP VARCHAR (20),
     CONSTRAINT FK_DEP FOREIGN KEY (COD_DEP) REFERENCES DEPARTAMENTO(COD_DEP) ON DELETE CASCADE
);

DROP TABLE ALUMNO cascade constraints;
CREATE TABLE ALUMNO (
    DNI_ALUM VARCHAR (20) PRIMARY KEY,
    NB_ALUM VARCHAR (20),
    DIR_ALUM VARCHAR (20),
    TF_ALUM NUMBER (20),
    FECHA_NAC DATE
);

DROP TABLE IMPARTE cascade constraints;
CREATE TABLE IMPARTE (
    COD_ASIG VARCHAR (10),
    DNI_PROF VARCHAR (20),
    DNI_ALUM VARCHAR (20),
    CONSTRAINT FK_ASIG FOREIGN KEY (COD_ASIG) REFERENCES ASIGNATURA(COD_ASIG) ON DELETE CASCADE,
    CONSTRAINT FK_PROF FOREIGN KEY (DNI_PROF) REFERENCES PROFESOR(DNI_PROF) ON DELETE CASCADE,
    CONSTRAINT FK_ALUM FOREIGN KEY (DNI_ALUM) REFERENCES ALUMNO(DNI_ALUM) ON DELETE CASCADE,
	CONSTRAINT PK_IMP PRIMARY KEY (COD_ASIG,DNI_PROF,DNI_ALUM)
);

/* === INSERTS ===*/

INSERT INTO ASIGNATURA VALUES ('001','BD');
INSERT INTO ASIGNATURA VALUES ('002','SERVIDOR');
INSERT INTO ASIGNATURA VALUES ('003','DESPLIEGUE');
COMMIT;

INSERT INTO DEPARTAMENTO VALUES ('I01','INFORMATICA');
COMMIT;

INSERT INTO PROFESOR VALUES ('000000001','CARMEN','C/Sol 20',600000001,2500,'I01');
INSERT INTO PROFESOR VALUES ('000000002','JORGE','C/Luna 15',600000002,2500,'I01');
INSERT INTO PROFESOR VALUES ('000000003','JAKELIN','C/Hola 10',600000003,2500,'I01');
COMMIT;

INSERT INTO ALUMNO VALUES ('000000010','ROMAN','C/Marchamalo 20',600000010,'01-12-1997');
INSERT INTO ALUMNO VALUES ('000000011','JAVIER','C/Hola 20',600000011,'01-12-1995');
INSERT INTO ALUMNO VALUES ('000000012','HENRY','C/Patata 15',600000012,'01-12-2000');
COMMIT;

INSERT INTO IMPARTE VALUES ('001','000000001','000000010');
INSERT INTO IMPARTE VALUES ('002','000000001','000000010');
INSERT INTO IMPARTE VALUES ('003','000000001','000000010');
INSERT INTO IMPARTE VALUES ('002','000000002','000000011');
INSERT INTO IMPARTE VALUES ('003','000000003','000000012');
COMMIT;

/* === SELECTS === */

DESC ASIGNATURA;
DESC DEPARTAMENTO;
DESC PROFESOR;
DESC ALUMNO;
DESC IMPARTE;

SELECT * FROM ASIGNATURA;
SELECT * FROM DEPARTAMENTO;
SELECT * FROM PROFESOR;
SELECT * FROM ALUMNO;
SELECT * FROM IMPARTE;